<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>Map</title>
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />
    <style>
        html,
        body,
        #map {
          height: 100%;
          margin: 0;
        }
        #status {
          position: absolute;
          left: 12px;
          bottom: 12px;
          background: rgba(0, 0, 0, 0.65);
          color: #fff;
          padding: 6px 10px;
          border-radius: 6px;
          font-size: 12px;
          z-index: 1000;
        }
                #tile-toggle {
          position: absolute;
          right: 12px;
          top: 12px;
          background: rgba(0, 0, 0, 0.65);
          color: #fff;
          padding: 6px 10px;
          border-radius: 6px;
          font-size: 12px;
          z-index: 1000;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        #tile-toggle input {
          margin: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="status">TIF: 等待加载...</div>
<label id="tile-toggle">
    <input id="tile-toggle-input" type="checkbox" checked />
    Edinburgh in 1844
</label>
<button id="tile-fit" type="button">定位瓦片</button>
<script>
    let map = null;
    let userMarker = null;
    let hasCentered = false;
    let userIcon = null;

    const GEO_CONFIG = {
      tileSize: 256,
      localTileEnabled: true,
      localTileUrl: "https://appassets.androidplatform.net/assets/tiles/{z}/{x}/{y}.png",
      localTileCrs: "EPSG:3395",
      localTileCrsDef: "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs",
      localTileBounds: [-20037508.3427892, -20037508.3427892, 20037508.3427892, 20037508.3427892],
    };
    function updateLocation(lat, lon) {
      if (!map) {
        return;
      }
      const latLng = [lat, lon];
      if (!userMarker) {
        userMarker = L.marker(latLng, { icon: userIcon }).addTo(map);
      } else {
        userMarker.setLatLng(latLng);
      }
      if (!hasCentered) {
        map.setView(latLng, 17);
        hasCentered = true;
      }
    }

    function centerOnUser(zoom) {
      if (!map || !userMarker) {
        return;
      }
      const targetZoom = Number.isFinite(zoom) ? zoom : map.getZoom();
      map.setView(userMarker.getLatLng(), targetZoom);
    }

    const statusEl = document.getElementById("status");
    const tileFitButton = document.getElementById("tile-fit");
    const tileToggleInput = document.getElementById("tile-toggle-input");

    function setLocalTilesVisible(visible) {
      if (!map || !rasterLayer) {
        return;
      }
      if (visible) {
        if (!map.hasLayer(rasterLayer)) {
          rasterLayer.addTo(map);
        }
      } else if (map.hasLayer(rasterLayer)) {
        map.removeLayer(rasterLayer);
      }
    }


    function setStatus(text) {
      if (statusEl) {
        statusEl.textContent = text;
      }
    }

        function getLocalTileBounds() {
      if (!map || !GEO_CONFIG.localTileBounds) {
        return null;
      }
      const [minX, minY, maxX, maxY] = GEO_CONFIG.localTileBounds;
      const crs = map.options.crs;
      if (!crs || typeof crs.unproject !== "function") {
        return null;
      }
      const southWest = crs.unproject(L.point(minX, minY));
      const northEast = crs.unproject(L.point(maxX, maxY));
      return L.latLngBounds(southWest, northEast);
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url;
        script.async = true;
        script.onload = () => resolve(url);
        script.onerror = () => reject(new Error(`脚本加载失败: ${url}`));
        document.head.appendChild(script);
      });
    }

    async function loadScriptsSequential(urls) {
      let lastError = null;
      for (const url of urls) {
        try {
          setStatus(`加载脚本: ${url}`);
          await loadScript(url);
          return url;
        } catch (error) {
          lastError = error;
        }
      }
      throw lastError || new Error("脚本加载失败");
    }

    function loadLocalTileLayer() {
      if (!map) {
        return;
      }
      const { localTileUrl, tileSize } = GEO_CONFIG;
      if (!localTileUrl) {
        setStatus("本地瓦片: 配置不完整");
        return;
      }

      setStatus("本地瓦片: 加载中...");
      rasterLayer = L.tileLayer(localTileUrl, {
        tileSize,
        maxZoom: 18,
        tms: false,
      });

      rasterLayer.addTo(map);
      setStatus("本地瓦片: 已加载");
    }

    function initMap() {
      map = L.map("map", {
        zoomControl: true,
        attributionControl: true,
      }).setView([39.9042, 116.4074], 15);

      L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", {
        subdomains: ["a", "b", "c"],
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, HOT',
      }).addTo(map);
    }

    async function loadLeaflet() {
      await loadScriptsSequential([
        "leaflet/leaflet.js",
      ]);
      if (typeof L === "undefined") {
        throw new Error("Leaflet 脚本未加载");
      }
      userIcon = L.icon({
        iconUrl: "https://appassets.androidplatform.net/res/drawable/cursor.png",
        iconSize: [100, 100],
        iconAnchor: [50, 50],
      });
    }

    async function initRasterLayer() {
      try {
        if (GEO_CONFIG.localTileEnabled) {
          loadLocalTileLayer();
          return;
        }
        setStatus("脚本加载完成，准备加载本地瓦片");
        loadLocalTiff();
      } catch (error) {
        console.error(error);
        setStatus(`脚本加载失败: ${error.message || error}`);
      }
    }

    async function init() {
      try {
        await loadLeaflet();
        initMap();
        await initRasterLayer();
        if (tileToggleInput) {
          tileToggleInput.checked = GEO_CONFIG.localTileEnabled;
          tileToggleInput.addEventListener("change", (event) => {
            setLocalTilesVisible(event.target.checked);
          });
        }
      } catch (error) {
        console.error(error);
        setStatus(`Leaflet 加载失败: ${error.message || error}`);
      }
    }

    init();
</script>
</body>
</html>